# Demo10_TwoWay_Communication - FreeRTOS 任务与中断双向通信示例

## 项目概述
本示例演示了FreeRTOS中任务与中断服务程序（ISR）之间的双向通信机制，通过二进制信号量实现中断事件的同步处理和状态反馈。

## 功能描述
- 使用双向二进制信号量实现任务与中断间的同步通信
- 中断检查任务状态，只在任务准备好时才发送处理请求
- 任务处理完成后通知中断可以接受下一个事件
- 实现中断防抖和错误统计功能
- LED指示灯显示系统运行状态

## 任务架构
| 任务名称 | 优先级 | 堆栈大小 | 功能描述 |
|---------|--------|----------|----------|
| log_task | 1 | 256 | 负责接收并打印带时间戳的日志消息 |
| Led_Task | 3 | 256 | 等待中断信号，处理事件并控制LED状态 |

## 双向通信机制

### 信号量设计
- **Task_TO_Interrupt_Binary**: 任务告知中断的准备状态
- **Interrupt_TO_Task_Binary**: 中断通知任务有事件需要处理

### 通信流程
```
1. 初始化：Task_TO_Interrupt_Binary 有一个信号量（任务准备就绪）
2. 按键中断发生 → EXTI3_IRQHandler()
3. 中断尝试获取 Task_TO_Interrupt_Binary（检查任务是否空闲）
4. 如果获取成功：
   - 释放 Interrupt_TO_Task_Binary（通知任务开始处理）
   - 更新统计信息
5. 任务接收到信号后：
   - 执行处理逻辑（LED闪烁）
   - 处理完成后释放 Task_TO_Interrupt_Binary（告知中断可再次响应）
```

## 关键特性

### 1. 中断防抖
- 在中断处理函数中实现50ms防抖处理
- 防止按键机械抖动导致的误触发

### 2. 状态指示
- **LED1**: 处理过程中闪烁3次，显示任务执行状态
- **LED2**: 高电平表示任务正在处理中，低电平表示任务空闲

### 3. 统计监控
```c
typedef struct {
    uint32_t interrupt_count;        // 中断总次数
    uint32_t task_process_count;     // 任务处理次数
    uint32_t communication_errors;   // 通信错误次数
    TickType_t last_interrupt_time;  // 最后一次中断时间
    TickType_t avg_process_time;     // 平均处理时间
} communication_stats_t;
```

### 4. 错误处理
- 检测任务繁忙时的中断丢失
- 信号量操作失败检测
- 实时错误计数和日志记录

## 硬件配置
- **按键**: GPIOC Pin3 (下降沿触发中断)
- **LED1**: 状态指示灯（处理过程显示）
- **LED2**: 忙碌指示灯（任务状态显示）

## 关键API使用
- `xSemaphoreCreateBinary()` - 创建二进制信号量
- `xSemaphoreGiveFromISR()` - 在中断中释放信号量
- `xSemaphoreTakeFromISR()` - 在中断中获取信号量
- `xSemaphoreTake()` - 在任务中获取信号量（阻塞等待）
- `xSemaphoreGive()` - 在任务中释放信号量
- `xTaskGetTickCountFromISR()` - 在中断中获取系统时间

## 工作流程示例
```
1. 系统启动 → 任务就绪，等待中断
2. 按下按键 → 中断产生
3. 中断检查任务状态 → 任务空闲
4. 中断发送处理信号 → 任务开始执行
5. LED2亮起 → 任务处理中
6. LED1闪烁3次 → 模拟处理过程
7. LED2熄灭 → 处理完成
8. 任务通知中断 → 准备接受下一个事件
```

## 预期效果
- 系统启动后显示初始化日志
- 按键按下时，LED2立即亮起表示开始处理
- LED1闪烁3次（每次600ms间隔）
- 处理完成后LED2熄灭，输出统计信息
- 串口显示详细的处理过程和时间戳

## 学习要点
1. **双向通信机制**: 理解任务与中断间的状态同步
2. **信号量应用**: 掌握二进制信号量在实时系统中的使用
3. **中断优化**: 学习如何最小化中断处理时间
4. **防抖技术**: 了解硬件防抖的软件实现方法
5. **错误处理**: 掌握实时系统中的错误检测和处理机制
6. **性能监控**: 学习如何统计和监控系统运行状态

## 扩展思考
- 如何处理多个中断源的优先级管理？
- 如何实现更复杂的任务间通信协议？
- 在高频中断环境下如何优化性能？
- 如何设计更完善的错误恢复机制
